---
import { getApiUrl, API_ENDPOINTS } from '~/config/api';

// Define interface for communication
interface Communication {
  id: string;
  title: string;
  category: string;
  priority: string;
  dateEnd?: string;
}

// Fetch active communications
let activeCommunications: Communication[] = [];
try {
  const response = await fetch(getApiUrl(API_ENDPOINTS.ANNUNCI));
  const data = await response.json();
  const today = new Date().toISOString().split('T')[0];
  
  // Filter active communications (not expired and priority high or medium)
  activeCommunications = data.announcements.filter((annuncio: Communication) => {
    const isNotExpired = !annuncio.dateEnd || annuncio.dateEnd >= today;
    const isActive = annuncio.priority === 'high' || annuncio.priority === 'medium';
    return isNotExpired && isActive;
  }).slice(0, 5); // Limit to 5 most recent
} catch (error) {
  console.error('Error fetching communications:', error);
  activeCommunications = [];
}

// Get category display names
const getCategoryDisplay = (category: string) => {
  const categoryMap: Record<string, string> = {
    'eventi': 'EVENTI',
    'giochi': 'GIOCHI', 
    'comunicazioni': 'COMUNICAZIONI'
  };
  return categoryMap[category] || category.toUpperCase();
};
---

{activeCommunications.length > 0 && (
  <div
    class="dark text-muted text-sm bg-black dark:bg-transparent dark:border-b dark:border-slate-800 dark:text-slate-400 hidden md:flex gap-1 overflow-hidden px-3 py-2 relative"
  >
    <div class="flex items-center gap-4 animate-scroll">
      {activeCommunications.map((comunicazione, index) => (
        <a 
          href={`/comunicazioni/${comunicazione.id}`}
          class="text-muted hover:underline dark:text-slate-400 font-medium flex items-center gap-2 whitespace-nowrap"
        >
          <span class="dark:bg-slate-700 bg-white/40 dark:text-slate-300 font-semibold px-1 py-0.5 text-xs">
            {getCategoryDisplay(comunicazione.category)}
          </span>
          <span>{comunicazione.title}</span>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </a>
      ))}
      {/* Duplica il contenuto per la rotazione continua */}
      {activeCommunications.map((comunicazione, index) => (
        <a 
          href={`/comunicazioni/${comunicazione.id}`}
          class="text-muted hover:underline dark:text-slate-400 font-medium flex items-center gap-2 whitespace-nowrap"
        >
          <span class="dark:bg-slate-700 bg-white/40 dark:text-slate-300 font-semibold px-1 py-0.5 text-xs">
            {getCategoryDisplay(comunicazione.category)}
          </span>
          <span>{comunicazione.title}</span>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </a>
      ))}
    </div>
  </div>
)}

<style>
  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }
  
  .animate-scroll {
    animation: scroll 20s linear infinite;
    width: 200%; /* Raddoppia la larghezza per contenere il contenuto duplicato */
  }
  
  .animate-scroll:hover {
    animation-play-state: paused;
  }
</style>
